# å‘å¸ƒ - è‡ªåŠ¨åŒ–å‘å¸ƒå·¥ä½œæµ
name: å‘å¸ƒ

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'è¦å‘å¸ƒçš„ç‰ˆæœ¬ï¼ˆä¾‹å¦‚ï¼Œv1.0.0ï¼‰'
        required: true
        type: string

permissions:
  contents: write

jobs:
  release:
    name: åˆ›å»ºå‘å¸ƒ
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è·å–ç‰ˆæœ¬
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: ç”Ÿæˆå˜æ›´æ—¥å¿—
        id: changelog
        uses: actions/github-script@v7
        with:
          script: |
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 1
            });

            const previousTag = releases.length > 0 ? releases[0].tag_name : '';

            let commits;
            if (previousTag) {
              const { data: comparison } = await github.rest.repos.compareCommits({
                owner: context.repo.owner,
                repo: context.repo.repo,
                base: previousTag,
                head: context.sha
              });
              commits = comparison.commits;
            } else {
              const { data: allCommits } = await github.rest.repos.listCommits({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 50
              });
              commits = allCommits;
            }

            const features = [];
            const fixes = [];
            const docs = [];
            const other = [];

            for (const commit of commits) {
              const message = commit.commit.message.split('\n')[0];
              const author = commit.author ? `@${commit.author.login}` : commit.commit.author.name;
              const sha = commit.sha.substring(0, 7);
              const entry = `- ${message} (${sha}) by ${author}`;

              if (message.startsWith('feat:') || message.startsWith('feat(')) {
                features.push(entry);
              } else if (message.startsWith('fix:') || message.startsWith('fix(')) {
                fixes.push(entry);
              } else if (message.startsWith('docs:') || message.startsWith('docs(')) {
                docs.push(entry);
              } else {
                other.push(entry);
              }
            }

            let changelog = '';

            if (features.length > 0) {
              changelog += '## âœ¨ æ–°åŠŸèƒ½\n\n' + features.join('\n') + '\n\n';
            }
            if (fixes.length > 0) {
              changelog += '## ğŸ› Bug ä¿®å¤\n\n' + fixes.join('\n') + '\n\n';
            }
            if (docs.length > 0) {
              changelog += '## ğŸ“š æ–‡æ¡£\n\n' + docs.join('\n') + '\n\n';
            }
            if (other.length > 0) {
              changelog += '## ğŸ”§ å…¶ä»–æ›´æ”¹\n\n' + other.join('\n') + '\n\n';
            }

            return changelog;
          result-encoding: string

      - name: åˆ›å»ºå‘å¸ƒ
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.version.outputs.version }}';
            const changelog = `${{ steps.changelog.outputs.result }}`;

            const releaseBody = `# Claude Code Multi-Agent ${version}

            ${changelog}

            ## å®‰è£…

            \`\`\`bash
            git clone https://github.com/Prorise-cool/Claude-Code-Multi-Agent.git
            cd Claude-Code-Multi-Agent
            uv sync
            \`\`\`

            ## å¿«é€Ÿå¼€å§‹

            1. å°† \`.env.example\` å¤åˆ¶ä¸º \`.env\`
            2. é…ç½®æ‚¨çš„ Ollama æ¨¡å‹
            3. å¼€å§‹ä½¿ç”¨å…·æœ‰å¢å¼ºå¤šä»£ç†åŠŸèƒ½çš„ Claude Codeï¼

            æŸ¥çœ‹ [README](https://github.com/Prorise-cool/Claude-Code-Multi-Agent#readme) è·å–è¯¦ç»†è¯´æ˜ã€‚

            ---
            **å®Œæ•´å˜æ›´æ—¥å¿—**: https://github.com/Prorise-cool/Claude-Code-Multi-Agent/compare/${version}...HEAD
            `;

            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: version,
              name: `å‘å¸ƒ ${version}`,
              body: releaseBody,
              draft: false,
              prerelease: version.includes('-')
            });
