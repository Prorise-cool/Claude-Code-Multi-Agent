# åŒæ­¥ä¸Šæ¸¸ - å…è®¸ Fork ç”¨æˆ·ä¸ä¸Šæ¸¸ä»“åº“åŒæ­¥
name: åŒæ­¥ä¸Šæ¸¸

on:
  schedule:
    # æ¯å‘¨æ—¥ UTC 00:00 è¿è¡Œ
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      sync_branch:
        description: 'è¦åŒæ­¥çš„åˆ†æ”¯ï¼ˆé»˜è®¤ï¼šmasterï¼‰'
        required: false
        default: 'master'
        type: string
      create_pr:
        description: 'åˆ›å»º PR è€Œä¸æ˜¯ç›´æ¥åˆå¹¶'
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    name: ä¸ä¸Šæ¸¸åŒæ­¥
    runs-on: ubuntu-latest
    # ä»…åœ¨ Fork ä¸Šè¿è¡Œ
    if: github.repository != 'Prorise-cool/Claude-Code-Multi-Agent'

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: é…ç½® Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: æ·»åŠ ä¸Šæ¸¸è¿œç¨‹
        run: |
          git remote add upstream https://github.com/Prorise-cool/Claude-Code-Multi-Agent.git || true
          git fetch upstream

      - name: è·å–åŒæ­¥åˆ†æ”¯
        id: branch
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "branch=${{ github.event.inputs.sync_branch }}" >> $GITHUB_OUTPUT
          else
            echo "branch=master" >> $GITHUB_OUTPUT
          fi

      - name: æ£€æŸ¥ä¸Šæ¸¸æ›´æ”¹
        id: check
        run: |
          BRANCH="${{ steps.branch.outputs.branch }}"
          LOCAL=$(git rev-parse HEAD)
          UPSTREAM=$(git rev-parse upstream/$BRANCH)

          if [ "$LOCAL" == "$UPSTREAM" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "æ²¡æœ‰éœ€è¦åŒæ­¥çš„æ›´æ”¹"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ°æ›´æ”¹ï¼Œå°†è¿›è¡ŒåŒæ­¥"

            # è·å–æ›´æ”¹çš„æ–‡ä»¶åˆ—è¡¨
            CHANGED_FILES=$(git diff --name-only HEAD upstream/$BRANCH | head -20)
            echo "changed_files<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: åˆ›å»ºåŒæ­¥åˆ†æ”¯
        if: steps.check.outputs.has_changes == 'true'
        run: |
          BRANCH="${{ steps.branch.outputs.branch }}"
          SYNC_BRANCH="sync-upstream-$(date +%Y%m%d)"

          git checkout -b $SYNC_BRANCH
          git merge upstream/$BRANCH --no-edit || {
            echo "æ£€æµ‹åˆ°åˆå¹¶å†²çª"
            git merge --abort
            exit 1
          }

          git push origin $SYNC_BRANCH

          echo "SYNC_BRANCH=$SYNC_BRANCH" >> $GITHUB_ENV

      - name: åˆ›å»ºæ‹‰å–è¯·æ±‚
        if: steps.check.outputs.has_changes == 'true' && (github.event.inputs.create_pr == 'true' || github.event_name == 'schedule')
        uses: actions/github-script@v7
        with:
          script: |
            const branch = '${{ steps.branch.outputs.branch }}';
            const syncBranch = process.env.SYNC_BRANCH;
            const changedFiles = `${{ steps.check.outputs.changed_files }}`;

            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ”„ ä¸ä¸Šæ¸¸åŒæ­¥ (${new Date().toISOString().split('T')[0]})`,
              head: syncBranch,
              base: branch,
              body: `## ä¸Šæ¸¸åŒæ­¥

            æ­¤ PR å°†æ‚¨çš„ Fork ä¸ä¸Šæ¸¸ä»“åº“åŒæ­¥ã€‚

            ### æ›´æ”¹çš„æ–‡ä»¶
            \`\`\`
            ${changedFiles}
            \`\`\`

            ### éœ€è¦åšä»€ä¹ˆ
            1. å®¡æŸ¥æ›´æ”¹
            2. è§£å†³ä»»ä½•å†²çªï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            3. å‡†å¤‡å°±ç»ªæ—¶åˆå¹¶

            ---
            *æ­¤ PR ç”± sync-upstream å·¥ä½œæµè‡ªåŠ¨åˆ›å»ºã€‚*
            `
            });

            // æ·»åŠ æ ‡ç­¾
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['upstream-sync', 'automated']
            });

            console.log(`å·²åˆ›å»º PR #${pr.number}`);

      - name: ç›´æ¥åˆå¹¶ï¼ˆå¦‚æœè¯·æ±‚ï¼‰
        if: steps.check.outputs.has_changes == 'true' && github.event.inputs.create_pr == 'false'
        run: |
          BRANCH="${{ steps.branch.outputs.branch }}"
          git checkout $BRANCH
          git merge upstream/$BRANCH --no-edit
          git push origin $BRANCH

  notify-no-changes:
    name: é€šçŸ¥æ— æ›´æ”¹
    runs-on: ubuntu-latest
    needs: sync
    if: always() && needs.sync.result == 'success'
    steps:
      - name: è®°å½•çŠ¶æ€
        run: echo "åŒæ­¥æ£€æŸ¥æˆåŠŸå®Œæˆ"
